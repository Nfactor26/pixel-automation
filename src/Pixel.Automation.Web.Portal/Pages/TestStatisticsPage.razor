@page "/test-statistics/{TestId?}"
@inject HttpClient Http

<MudGrid Elevation="4" Justify="Justify.Center">
    <MudItem xs="12">
        <MudPaper Elevation="3" Class="d-flex flex-row pt-4 pl-3" Style="height:60px;">
            <MudText Typo="Typo.h5" Color="Color.Info">Test Statistics</MudText>
        </MudPaper>
    </MudItem>
</MudGrid>
<br />

<MudGrid Spacing="4" Justify="Justify.FlexStart">
    <MudItem xs="12">
        <MudGrid Spacing="4">
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="4" Class="d-flex flex-row pt-6 pb-4" Style="height:100px;">
                    @if (statisticsViewModel.SuccessRate > 80)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Color="Color.Success" Class="mx-4" Style="width:54px; height:54px;"></MudIcon>
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.TrendingDown" Color="Color.Warning" Class="mx-4" Style="width:54px; height:54px;"></MudIcon>
                    }
                    <div>
                        <MudText Typo="Typo.subtitle1" Class="mud-text-secondary mb-n1">Sucess Rate</MudText>
                        <MudText Typo="Typo.subtitle2">@statisticsViewModel.SuccessRate %</MudText>
                    </div>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="4" Class="d-flex flex-row pt-6 pb-4" Style="height:100px;">
                    <MudIcon Icon="@Icons.Material.Filled.Timer" Color="Color.Info" Class="mx-4" Style="width:54px; height:54px;"></MudIcon>
                    <div>
                        <MudText Typo="Typo.subtitle1" Class="mud-text-secondary mb-n1">Avg Execution Time</MudText>
                        <MudText Typo="Typo.subtitle2">@statisticsViewModel.AvgExecutionTime s</MudText>
                    </div>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudItem>
    <MudItem xs="3">
        <MudCard Elevation="4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudAlert Severity="Severity.Normal" NoIcon="true">Overall Execution Stats</MudAlert>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <Pixel.Automation.Web.Portal.Components.Charts.DonutChart ChartData="@statisticsViewModel?.ExecutionSummaryChartData"></Pixel.Automation.Web.Portal.Components.Charts.DonutChart>
            </MudCardContent>
        </MudCard>
    </MudItem>
    <MudItem xs="9">
        <MudCard Elevation="4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudAlert Severity="Severity.Normal" NoIcon="true">Executions History (Last 6 months)</MudAlert>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <Pixel.Automation.Web.Portal.Components.Charts.BarChart ChartData="@statisticsViewModel?.MonthlyExecutionHistoryData"></Pixel.Automation.Web.Portal.Components.Charts.BarChart>
            </MudCardContent>
        </MudCard>
    </MudItem>
    <MudItem xs="12">
        <FailureDetailsTable TableHeader="Unique Failures" Failures="@statisticsViewModel.UniqueFailures"></FailureDetailsTable>
    </MudItem>
</MudGrid>



@code {

    public string Search { get; set; }

    [Parameter]
    public string TestId { get; set; }

    private TestStatisticsViewModel statisticsViewModel = new TestStatisticsViewModel();

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(TestId))
        {
            var statistics = await Http.GetFromJsonAsync<TestStatistics>($"/api/TestStatistics/{TestId}");
            statisticsViewModel = new TestStatisticsViewModel(statistics);
        }
    }

}
